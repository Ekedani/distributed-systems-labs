services:
  envoy:
    image: envoyproxy/envoy:v1.36.2
    container_name: envoy
    volumes:
      - ./envoy.yaml:/etc/envoy/envoy.yaml:ro
    depends_on:
      - dispatcher

  gateway:
    build:
      context: ./gateway
    container_name: gateway
    environment:
      PORT: ${GATEWAY_PORT}
      DISPATCHER_HOST: ${GATEWAY_DISPATCHER_HOST}
      DISPATCHER_PORT: ${GATEWAY_DISPATCHER_PORT}
      DISPATCHER_PACKAGE: ${GATEWAY_DISPATCHER_PACKAGE}
    ports:
      - "${GATEWAY_PORT}:3000"
    depends_on:
      - envoy

  dispatcher:
    build:
      context: ./services/dispatcher
    environment:
      GRPC_HOST: ${DISPATCHER_GRPC_HOST}
      GRPC_PORT: ${DISPATCHER_GRPC_PORT}
      GRPC_PACKAGE: ${DISPATCHER_GRPC_PACKAGE}
      WORKER_HOST: ${DISPATCHER_WORKER_HOST}
      WORKER_PORT: ${DISPATCHER_WORKER_PORT}
      WORKER_PACKAGE: ${DISPATCHER_WORKER_PACKAGE}
      MONGODB_URI: ${DISPATCHER_MONGODB_URI}
      KAFKA_BROKERS: ${KAFKA_BROKERS}
      KAFKA_CLIENT_ID: ${DISPATCHER_KAFKA_CLIENT_ID}
    depends_on:
      mongo1:
        condition: service_healthy
      kafka-init:
        condition: service_completed_successfully
        
  worker:
    build:
      context: ./services/worker
    environment:
      GRPC_HOST: ${WORKER_GRPC_HOST}
      GRPC_PORT: ${WORKER_GRPC_PORT}
      GRPC_PACKAGE: ${WORKER_GRPC_PACKAGE}
      KAFKA_BROKERS: ${KAFKA_BROKERS}
      KAFKA_CLIENT_ID: ${WORKER_KAFKA_CLIENT_ID}
      KAFKA_CONSUMER_GROUP_ID: ${WORKER_KAFKA_CONSUMER_GROUP_ID}
    depends_on:
      kafka-init:
        condition: service_completed_successfully
    deploy:
      replicas: 2

  kafka:
    image: confluentinc/cp-kafka:7.9.5
    container_name: kafka
    environment:
      KAFKA_NODE_ID: ${KAFKA_NODE_ID}
      KAFKA_PROCESS_ROLES: ${KAFKA_PROCESS_ROLES}
      KAFKA_CONTROLLER_QUORUM_VOTERS: ${KAFKA_CONTROLLER_QUORUM_VOTERS}
      KAFKA_LISTENERS: ${KAFKA_LISTENERS}
      KAFKA_ADVERTISED_LISTENERS: ${KAFKA_ADVERTISED_LISTENERS}
      KAFKA_INTER_BROKER_LISTENER_NAME: ${KAFKA_INTER_BROKER_LISTENER_NAME}
      KAFKA_CONTROLLER_LISTENER_NAMES: ${KAFKA_CONTROLLER_LISTENER_NAMES}
      KAFKA_DEFAULT_REPLICATION_FACTOR: ${KAFKA_DEFAULT_REPLICATION_FACTOR}
      KAFKA_MIN_INSYNC_REPLICAS: ${KAFKA_MIN_INSYNC_REPLICAS}
      KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR: ${KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR}
      KAFKA_AUTO_CREATE_TOPICS_ENABLE: ${KAFKA_AUTO_CREATE_TOPICS_ENABLE}
      CLUSTER_ID: MkQkSjQ4OThiNDJkYjQ2MjE=
    ports:
      - "${KAFKA_PORT}:9092"

  kafka-init:
    image: confluentinc/cp-kafka:7.9.5
    container_name: kafka-init
    depends_on:
      - kafka
    entrypoint: |
      bash -c "
      echo 'Waiting for Kafka to be ready...'
      sleep 15
      echo 'Creating topics...'
      kafka-topics --bootstrap-server kafka:9092 --create --if-not-exists --topic notifications.events --partitions 1 --replication-factor 1
      kafka-topics --bootstrap-server kafka:9092 --create --if-not-exists --topic notifications.commands --partitions 2 --replication-factor 1
      echo 'Topics created. Listing topics:'
      kafka-topics --bootstrap-server kafka:9092 --list
      echo 'Topic creation complete'
      "

  orchestrator:
    build:
      context: ./services/orchestrator
    environment:
      KAFKA_BROKERS: ${KAFKA_BROKERS}
      KAFKA_CLIENT_ID: ${ORCHESTRATOR_KAFKA_CLIENT_ID}
      KAFKA_CONSUMER_GROUP_ID: ${ORCHESTRATOR_KAFKA_CONSUMER_GROUP_ID}
    depends_on:
      kafka-init:
        condition: service_completed_successfully

  materializer:
    build:
      context: ./services/materializer
    environment:
      MONGODB_URI: ${MATERIALIZER_MONGODB_URI}
      KAFKA_BROKERS: ${KAFKA_BROKERS}
      KAFKA_CLIENT_ID: ${MATERIALIZER_KAFKA_CLIENT_ID}
      KAFKA_CONSUMER_GROUP_ID: ${MATERIALIZER_KAFKA_CONSUMER_GROUP_ID}
    depends_on:
      mongo1:
        condition: service_healthy
      kafka-init:
        condition: service_completed_successfully

  mongo1:
    image: mongo:8
    container_name: mongo1
    command: ["--replSet", "rs0", "--bind_ip_all", "--port", "27017"]
    ports:
      - "27017:27017"
    volumes:
      - mongo1-data:/data/db
    healthcheck:
      test: echo "try { rs.status() } catch (err) { rs.initiate({_id:'rs0',members:[{_id:0,host:'mongo1:27017'},{_id:1,host:'mongo2:27018'},{_id:2,host:'mongo3:27019'}]}) }" | mongosh --port 27017 --quiet
      interval: 5s
      timeout: 30s
      retries: 30

  mongo2:
    image: mongo:8
    container_name: mongo2
    command: ["--replSet", "rs0", "--bind_ip_all", "--port", "27018"]
    ports:
      - "27018:27018"
    volumes:
      - mongo2-data:/data/db

  mongo3:
    image: mongo:8
    container_name: mongo3
    command: ["--replSet", "rs0", "--bind_ip_all", "--port", "27019"]
    ports:
      - "27019:27019"
    volumes:
      - mongo3-data:/data/db

volumes:
  mongo1-data:
  mongo2-data:
  mongo3-data:
